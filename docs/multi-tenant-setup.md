# Multi-Tenant Authentication and RBAC Setup Guide

## Overview

This guide covers the setup and configuration of multi-tenant authentication and Role-Based Access Control (RBAC) for the Bhashini QoS monitoring system using Grafana OSS. The system provides secure, isolated access for different customer organizations while maintaining provider oversight capabilities.

## Architecture

### Organization Structure

```
Bhashini QoS Monitoring
├── Bhashini-Provider (Org ID: 1)
│   ├── Provider Admin (Full access)
│   ├── Provider Analyst (Cross-tenant analytics)
│   └── Cross-tenant data access
│
├── Customer-1 (Org ID: 2)
│   ├── Customer Admin (Org management)
│   ├── Customer Viewer (Read-only access)
│   └── Tenant-isolated data (enterprise_1)
│
├── Customer-2 (Org ID: 3)
│   ├── Customer Admin (Org management)
│   ├── Customer Viewer (Read-only access)
│   └── Tenant-isolated data (startup_2)
│
└── Customer-3 (Org ID: 4)
    ├── Customer Admin (Org management)
    ├── Customer Viewer (Read-only access)
    └── Tenant-isolated data (freemium_1)
```

### Data Isolation Mechanism

The system uses **tag-based data isolation** in InfluxDB:

- **Primary Tag**: `tenant_id` (enterprise_1, startup_2, freemium_1)
- **Additional Tags**: `sla_tier`, `service_name`, `metric_type`
- **Query Filtering**: Automatic tenant isolation through Grafana query templates

## Prerequisites

- Docker and Docker Compose running
- Grafana and InfluxDB services started
- Basic QoS monitoring stack operational
- Ports 3000 (Grafana) and 8086 (InfluxDB) available

## Setup Process

### 1. Environment Configuration

Update your `.env` file with multi-tenant settings:

```bash
# Multi-Tenant Authentication Configuration
GRAFANA_API_KEY_ENABLED=true
GRAFANA_USERS_AUTO_ASSIGN_ORG=true
GRAFANA_USERS_AUTO_ASSIGN_ORG_ROLE=Viewer
GRAFANA_USERS_ALLOW_SIGN_UP=true
GRAFANA_USERS_VERIFY_EMAIL_ENABLED=false
GRAFANA_DEFAULT_ORG_NAME=Bhashini
GRAFANA_DISABLE_GRAVATAR=true

# Organization Management
GRAFANA_PROVIDER_ORG_NAME=Bhashini-Provider
GRAFANA_CUSTOMER_ORG_PREFIX=Customer

# Customer Organization Tokens (generated by init script)
INFLUXDB_CUSTOMER_1_TOKEN=your_customer_1_token_here
INFLUXDB_CUSTOMER_2_TOKEN=your_customer_2_token_here
INFLUXDB_CUSTOMER_3_TOKEN=your_customer_3_token_here

# Provider Cross-Tenant Access Token
INFLUXDB_PROVIDER_CROSS_TENANT_TOKEN=your_provider_cross_tenant_token_here
```

### 2. InfluxDB Token Generation

Run the tenant token generation script:

```bash
# Make script executable
chmod +x influxdb/init-scripts/03-create-tenant-tokens.sh

# Run token generation (after InfluxDB is running)
docker exec -it bhashini-influxdb /bin/bash
cd /docker-entrypoint-initdb.d
./03-create-tenant-tokens.sh
```

This script creates:
- Provider cross-tenant access token
- Customer-specific read-only tokens
- Tenant-specific buckets for data isolation

### 3. Grafana Organization Setup

Run the organization setup script:

```bash
# Install dependencies
pip install -r scripts/requirements.txt

# Run organization setup
python scripts/setup-organizations.py
```

This script creates:
- Provider organization with admin users
- Customer organizations with appropriate roles
- User assignments and role configurations

### 4. Test User Creation

Create test users for different scenarios:

```bash
python scripts/create-test-users.py
```

This creates:
- Provider test users (Admin, Editor, Viewer)
- Customer test users for each organization
- API keys for programmatic access

### 5. Authentication Testing

Verify the complete setup:

```bash
python scripts/test-authentication.py
```

This tests:
- Basic authentication for all user types
- API key authentication
- Organization access controls
- Data source connectivity
- Multi-tenant data isolation

## User Management

### User Roles and Permissions

#### Provider Organization
- **Provider Admin**: Full system access, cross-tenant analytics
- **Provider Analyst**: Cross-tenant data access, dashboard creation

#### Customer Organizations
- **Customer Admin**: Organization management, user administration
- **Customer Editor**: Dashboard creation and editing
- **Customer Viewer**: Read-only access to tenant data

### API Key Management

Each user can generate API keys for programmatic access:

```bash
# Example: Create API key for provider admin
curl -X POST http://localhost:3000/api/auth/keys \
  -H "Content-Type: application/json" \
  -d '{"name": "provider-api-key", "role": "Admin"}' \
  -u "provider.admin@bhashini.com:ProviderAdmin123!"
```

## Data Access Patterns

### Provider Queries (Cross-Tenant)

```flux
// Cross-tenant performance comparison
from(bucket: "qos_metrics")
  |> range(start: -24h)
  |> filter(fn: (r) => r["_measurement"] == "qos_metrics")
  |> filter(fn: (r) => r["metric_type"] == "latency")
  |> group(columns: ["tenant_id", "service_name"])
  |> mean()
  |> pivot(rowKey:["_time"], columnKey: ["_field"], valueColumn: "_value")
```

### Customer Queries (Tenant-Isolated)

```flux
// Tenant-specific metrics (automatically filtered)
from(bucket: "qos_metrics")
  |> range(start: -1h)
  |> filter(fn: (r) => r["_measurement"] == "qos_metrics")
  |> filter(fn: (r) => r["tenant_id"] == "enterprise_1")
  |> group(columns: ["service_name", "metric_type"])
  |> mean()
```

## Security Considerations

### Authentication Methods

1. **Basic Authentication**: Username/password for interactive access
2. **API Keys**: Long-lived tokens for programmatic access
3. **Session Management**: Configurable timeout and security policies

### Data Isolation

- **Tag-based filtering**: Automatic tenant isolation in queries
- **Bucket-level access**: Customer tokens restricted to specific data
- **Role-based permissions**: Granular access control within organizations

### Security Best Practices

- Use strong passwords (minimum 8 characters, special chars, numbers, uppercase)
- Rotate API keys regularly (90-day expiry)
- Monitor authentication attempts and access patterns
- Implement session timeout policies
- Disable anonymous access

## Monitoring and Alerting

### Authentication Metrics

The system tracks:
- User login attempts (successful/failed)
- API key usage patterns
- Data access patterns by tenant
- Organization activity levels

### Alerts

Configured alerts include:
- Failed login attempts (5+ in 5 minutes)
- API key expiry warnings (7 days before expiry)
- Unusual data access patterns

## Troubleshooting

### Common Issues

#### 1. Authentication Failures

**Symptoms**: Users cannot log in, API keys rejected
**Solutions**:
- Verify user credentials in Grafana admin panel
- Check organization assignments
- Validate API key permissions

#### 2. Data Access Issues

**Symptoms**: Users cannot see expected data
**Solutions**:
- Verify tenant_id tags in InfluxDB
- Check data source configuration
- Validate user organization membership

#### 3. Organization Isolation Problems

**Symptoms**: Customers can see other tenant data
**Solutions**:
- Review query templates and filters
- Verify InfluxDB token permissions
- Check Grafana organization settings

### Debug Commands

```bash
# Check Grafana organization status
curl -u admin:admin http://localhost:3000/api/orgs

# Verify user assignments
curl -u admin:admin http://localhost:3000/api/orgs/2/users

# Test data source connectivity
curl -u admin:admin http://localhost:3000/api/datasources

# Check InfluxDB token validity
curl -H "Authorization: Token YOUR_TOKEN" \
  http://localhost:8086/api/v2/buckets
```

### Log Analysis

Monitor Grafana logs for authentication issues:

```bash
docker logs bhashini-grafana | grep -i "auth\|login\|error"
```

## Scaling Considerations

### Adding New Customers

1. **Update Configuration**: Add customer to `config/tenant-config.yml`
2. **Generate Tokens**: Run tenant token script for new customer
3. **Create Organization**: Use setup script or Grafana API
4. **Assign Users**: Create customer admin and viewer accounts
5. **Configure Data Sources**: Set up tenant-specific InfluxDB connections

### Performance Optimization

- **Connection Pooling**: Configure appropriate connection limits
- **Query Optimization**: Use efficient Flux queries with proper filtering
- **Caching**: Leverage Grafana's built-in caching mechanisms
- **Resource Limits**: Set appropriate quotas for dashboards and users

## Limitations and Future Enhancements

### Current Limitations (Grafana OSS)

- **Basic RBAC**: Limited to organization and role-based access
- **No Advanced Permissions**: Cannot set granular resource-level permissions
- **Manual User Management**: No automated user provisioning workflows

### Enterprise Features (Future Consideration)

- **Advanced RBAC**: Fine-grained permission control
- **SAML/LDAP Integration**: Enterprise authentication providers
- **Audit Logging**: Comprehensive access audit trails
- **Automated Provisioning**: SCIM integration for user management

### Migration Path

When upgrading to Grafana Enterprise:
1. Export current organization structure
2. Import into Enterprise instance
3. Configure advanced RBAC policies
4. Enable enterprise authentication features
5. Update data source configurations

## Support and Maintenance

### Regular Maintenance Tasks

- **Monthly**: Review and rotate API keys
- **Quarterly**: Audit user access and permissions
- **Annually**: Review and update security policies

### Backup and Recovery

- **Configuration Backup**: Export Grafana configuration
- **User Data Backup**: Backup organization and user settings
- **Disaster Recovery**: Document recovery procedures

### Monitoring and Updates

- **Version Updates**: Keep Grafana and InfluxDB updated
- **Security Patches**: Apply security updates promptly
- **Performance Monitoring**: Track authentication performance metrics

## Conclusion

This multi-tenant setup provides a secure, scalable foundation for Bhashini QoS monitoring. While Grafana OSS has limitations compared to Enterprise, the tag-based data isolation and organization structure provide adequate security for most use cases.

For production deployments, consider:
- Implementing additional security layers (reverse proxy, WAF)
- Setting up monitoring and alerting for security events
- Regular security audits and penetration testing
- Backup and disaster recovery procedures

## Additional Resources

- [Grafana Multi-Tenancy Documentation](https://grafana.com/docs/grafana/latest/setup-grafana/configure-security/configure-authentication/)
- [InfluxDB Authorization Guide](https://docs.influxdata.com/influxdb/v2.7/security/tokens/)
- [Flux Query Language Reference](https://docs.influxdata.com/flux/)
- [Grafana API Reference](https://grafana.com/docs/grafana/latest/developers/http_api/)
